# CLAUDE.md - Future Instructions

## 1. Generated Files - Do Not Edit Directly

**IMPORTANT: Some files are automatically generated and should NOT be edited manually:**

- `.github/workflows/stages.yml` - Generated by `make stages`
- `DOCKER_DEPENDENCY_ANALYSIS.md` - Generated by `make analysis`
- Individual `Makefile` files in each Docker directory - Generated by `make generate-makefiles`

**When you need to modify these files:**

- Instead of editing directly, modify the `generate_stages.py` script
- Run the appropriate make target to regenerate:
    - `make stages` - Regenerate workflow file
    - `make analysis` - Regenerate dependency analysis
    - `make generate-makefiles` - Regenerate all individual Makefiles
- Look for header comments like "Generated by generate_stages.py, do not edit by hand" to identify generated files

## 2. Use `pak::pak()` for R Package Installation

- **Always use** `pak::pak(c("package1", "package2"))` instead of `install.packages()`
- Benefits: faster parallel downloads, better dependency resolution, more robust error handling
- Example: `RUN R -q -e 'pak::pak(c("devtools", "usethis", "languageserver"))'`

## 3. Preserve Cache Invalidation Files

- **Do not remove** `COPY date.txt /date.txt` lines from Dockerfiles
- These files are used for build cache invalidation to ensure fresh package installations
- When date.txt changes, it forces rebuilds of the entire pipeline

## 4. Use Concatenated Commands for Layer Optimization

- **Always concatenate** related RUN commands using `&&` to minimize Docker layers
- **Always include cleanup** at the end. Ubuntu example: `rm -rf /var/lib/apt/lists/* && rm -rf /tmp/* && rm -rf /var/tmp/*`
- Group logical operations together: system package installation, R package installation, configuration
- RUN followed by backslash, && \ at the end of each line, true in the last line
- Example:

  ```dockerfile
  # Install system dependencies and R packages, then clean up
  RUN apt-get update && apt-get install -y package1 package2 && \
      R -q -e 'pak::pak(c("pkg1", "pkg2"))' && \
      rm -rf /var/lib/apt/lists/* && \
      rm -rf /tmp/* && \
      rm -rf /var/tmp/* && \
      true
  ```

## 5. Docker Image Architecture Best Practices

- Maintain logical build pipeline staging based on dependencies
- Use minimal image layers and appropriate base images
- Separate concerns: base images, R variants, specialized tools
- Document image purposes and dependencies clearly

## 6. Multi-Architecture Builds

- All images are built for both **amd64** and **arm64** architectures
- The workflow automatically provides `TARGETARCH` and `TARGETPLATFORM` build arguments
- **To use architecture information in your Dockerfile:**

  ```dockerfile
  # Declare the build arguments
  ARG TARGETARCH
  ARG TARGETPLATFORM

  # Use them in RUN commands
  RUN echo "Building for ${TARGETARCH} on ${TARGETPLATFORM}"

  # For architecture-specific logic
  RUN if [ "$TARGETARCH" = "arm64" ]; then \
        echo "ARM64-specific setup"; \
      fi
  ```

- See `MULTI_ARCH_USAGE.md` for complete examples and patterns
- Architecture-specific tags (e.g., `latest-amd64`, `latest-arm64`) are created during build
- A unified manifest combines both architectures under the `latest` tag

## 7. Formatting

- Use pylint and black for Python code formatting

## 8. Always Update CLAUDE.md

- **Always update** this CLAUDE.md file when making changes to Docker images or establishing new patterns
- Include any new best practices, patterns, or important considerations discovered during development
- Keep this file as a comprehensive guide for future maintenance and development
